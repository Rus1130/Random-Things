<style>
    #area {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
    }
    svg {
        overflow: visible;
    }
    #player {
        position: absolute;
        top: calc(50% - 33px);
        left: calc(50% - 26px);
    }
</style>
<head>

</head>
<body>
    <div id="area">
        <svg width="50" height="50" id='player' viewBox="0 0 50 50" transformOrigin="24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="50" height="50" fill="#FF0000"/>
            <rect x="24" y="24" id="cannonCenterer" width="2" height="2" fill="yellow"/>
            <g id="cannon">
                <rect x="16" y="18" width="50" height="15" fill="black"/>
            </g>
        </svg>
    </div>
</body>
<script>
    const area = document.getElementById('area');

    const gameData = {
        x: 0,
        y: 0,
        interval: null,
        up: 'w',
        down: 's',
        left: 'a',
        right: 'd',
        cannonAngle: 0,
        speed: 1,
        bulletSpeed: 0.9,
        friction: 0.95,
        xp: 0,
        levels: {
            1: {
                svg: '<path d="M15 15H34.6078V35H15V15Z" fill="black"/>',
                xp: 10,
            }
        },
        mouseX: 0,
        mouseX: 0,
        intervalLength: 1000/60,
        
    }

    function move(x, y){
        const player = document.getElementById('player');
        const playerRect = player.getBoundingClientRect();
        const areaRect = area.getBoundingClientRect();
        const newX = playerRect.left + x;
        const newY = playerRect.top + y;
        if(newX >= areaRect.left && newX <= areaRect.right - playerRect.width){
            player.style.left = newX + 'px';
        }
        if(newY >= areaRect.top && newY <= areaRect.bottom - playerRect.height){
            player.style.top = newY + 'px';
        }
    }

    function moveBullet(x, y, bullet){
        const bulletRect = bullet.getBoundingClientRect();
        const areaRect = area.getBoundingClientRect();
        const newX = bulletRect.left + x;
        const newY = bulletRect.top + y;
        if(newX >= areaRect.left && newX <= areaRect.right - bulletRect.width){
            bullet.style.left = newX + 'px';
        }
        if(newY >= areaRect.top && newY <= areaRect.bottom - bulletRect.height){
            bullet.style.top = newY + 'px';
        }
    }


    // add a player controler that has smooth movement, multiple keys, friction, and rotates the player based on the direction they are moving
    function mouseController(e){
        document.addEventListener('mousemove', onMouseUpdate, false);
        document.addEventListener('mouseenter', onMouseUpdate, false);
            
        function onMouseUpdate(e) {
            gameData.mouseX = e.pageX;
            gameData.mouseY = e.pageY;
        }
    }

    function playerController(){
        const player = document.getElementById('player');
        const playerRect = player.getBoundingClientRect();
        const areaRect = area.getBoundingClientRect();
        const keys = {};
        window.addEventListener('keydown', function(e){
            keys[e.key] = true;
        });
        window.addEventListener('keyup', function(e){
            keys[e.key] = false;
        });
        function movePlayer(){
            if(keys[gameData.up]){
                gameData.y -= gameData.speed;
            }
            if(keys[gameData.down]){
                gameData.y += gameData.speed;
            }
            if(keys[gameData.left]){
                gameData.x -= gameData.speed;
            }
            if(keys[gameData.right]){
                gameData.x += gameData.speed;
            }
            
            gameData.x *= gameData.friction;
            gameData.y *= gameData.friction;
            
            move(gameData.x, gameData.y);
        }
        gameData.interval = setInterval(movePlayer, 1000/60);

        function updateCannonAngle(){
            const cannon = document.getElementById('cannon');
            const cannonCenterer = document.getElementById('cannonCenterer');
            const cannonCentererRect = cannonCenterer.getBoundingClientRect();
            const playerRect = player.getBoundingClientRect();
            const areaRect = area.getBoundingClientRect();
            const mouseX = gameData.mouseX;
            const mouseY = gameData.mouseY;
            const cannonCentererX = cannonCentererRect.left + (cannonCentererRect.width / 2);
            const cannonCentererY = cannonCentererRect.top + (cannonCentererRect.height / 2);
            const playerX = playerRect.left + (playerRect.width / 2);
            const playerY = playerRect.top + (playerRect.height / 2);
            const angle = Math.atan2(mouseY - cannonCentererY, mouseX - cannonCentererX) * 180 / Math.PI;
            gameData.cannonAngle = angle;
        }

        setInterval(updateCannonAngle, 1000/60);
        setInterval(mouseController, 1000/60);
    }

    function rotate_point(pointX,pointY,originX,originY,angle) {
        angle = angle * Math.PI / 180.0;
        return {
            x: Math.cos(angle) * (pointX-originX) - Math.sin(angle) * (pointY-originY) + originX,
            y: Math.sin(angle) * (pointX-originX) + Math.cos(angle) * (pointY-originY) + originY
        };
    }
    function cannonController(){
        function rotateCannon(){
            const player = document.getElementById('player');
            const playerRect = player.getBoundingClientRect();
            const cannon = document.getElementById('cannon');
            const cannonCenterer = document.getElementById('cannonCenterer');
            const cannonCentererRect = cannonCenterer.getBoundingClientRect();
            const cannonRect = cannon.getBoundingClientRect();
            const cannonCentererX = cannonCentererRect.left + cannonCentererRect.width/2;
            const cannonCentererY = cannonCentererRect.top + cannonCentererRect.height/2;
            const mouseX = gameData.mouseX
            const mouseY = gameData.mouseY
            const angle = (Math.atan2(mouseY - cannonCentererY, mouseX - cannonCentererX)) * 180 / Math.PI;
            const newPoint = rotate_point(cannonRect.left, cannonRect.top, cannonCentererX, cannonCentererY, angle);

            cannon.style.transformOrigin = `${cannonCentererX - playerRect.left}px ${cannonCentererY - playerRect.top}px`;
            cannon.style.transform = `rotate(${gameData.cannonAngle}deg)`;
        }
       
        
        setInterval(rotateCannon, 1000/60);
        
    }

    // on click, create a bullet that is placed at the end of the barrel and moves in the direction of the cannon, and when it hits anything that is an svg, console log the id of the svg
    function bulletController(){
        window.addEventListener('click', function(e){
            // get the x and y coordinates of the end of the barrel
            const player = document.getElementById('player');
            const playerRect = player.getBoundingClientRect();
            const cannon = document.getElementById('cannon');
            const cannonRect = cannon.getBoundingClientRect();
            const cannonCenterer = document.getElementById('cannonCenterer');
            const cannonCentererRect = cannonCenterer.getBoundingClientRect();
            // place the bullet in the center of the player
            const bullet = document.createElement('div');
            bullet.style.position = 'absolute';
            bullet.style.left = playerRect.left + playerRect.width/2 + 'px';
            bullet.style.top = playerRect.top + playerRect.height/2 + 'px';
            bullet.style.width = '10px';
            bullet.style.height = '10px';
            bullet.style.backgroundColor = 'black';
            bullet.style.borderRadius = '50%';
            area.appendChild(bullet);
            const angle = gameData.cannonAngle;
            const bulletData = {
                x: 0,
                y: 0,
                speed: 0.5,
                angle: angle,
                interval: null
            }
            function updateBulletPos(){
                bulletData.x += bulletData.speed * Math.cos(bulletData.angle * Math.PI / 180);
                bulletData.y += bulletData.speed * Math.sin(bulletData.angle * Math.PI / 180);
                moveBullet(bulletData.x, bulletData.y, bullet);
                // if the bullet hits an svg, console log the id of the svg
                const bulletRect = bullet.getBoundingClientRect();
                const areaRect = area.getBoundingClientRect();
                const svgElements = document.getElementsByTagName('svg');
                for(let i = 0; i < svgElements.length; i++){
                    const svgRect = svgElements[i].getBoundingClientRect();
                    if(bulletRect.left > svgRect.left && bulletRect.left < svgRect.left + svgRect.width && bulletRect.top > svgRect.top && bulletRect.top < svgRect.top + svgRect.height && svgElements[i].id != 'player'){
                        console.log(svgElements[i].id);
                        clearInterval(bulletData.interval);
                        bullet.remove();
                    }
                }
            }
            bulletData.interval = setInterval(updateBulletPos, 1000/60);
        });
    }


    // onload event
    bulletController();
    playerController();
    cannonController();
</script>