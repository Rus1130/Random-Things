<style>
#grid {
    display: grid;
    width: 500px;
    height: 500px;
    grid-gap: 2px;
}
.hidden {
    display: none;
}
#gui {
    position: absolute;
    right: 10px;
    top: 5px;
}
#inventoryButton, #shopButton {
    width: 100px;
    height: 50px;
    border: 1px solid black;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 5px;
}
#menu {
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 135px;
    left: 550px;
    width: 500px;
    height: 500px;
    border: 1px solid black;
}
</style>
<head>
    <script src="main.js"></script>
</head>
<body>
    <div>type directions() in the console to get started</div>
    <div id="levelDisplay">Level 1 (0/10)</div>
    <div id='heatDisplay'>Heat: 0/100</div>
    <div id="partitionRecordsCount">Partition Records: 0</div>
    <div id='dayCounter'>Day 1</div>
    <div id="nextDayCounter">Seconds Until Day End:</div>
    <div id="timer" class="hidden"></div>
    <div id="grid" class="hidden"></div>
    <div id="gui">
        <div id="inventoryButton">Inventory</div>
        <div id="shopButton">Shop</div>
    </div>
    <div id="menu" style="display: none;"></div>
</body>
<script>

    const heatDisplay = document.getElementById('heatDisplay');
    const dayCounter = document.getElementById('dayCounter');
    const nextDayCounter = document.getElementById('nextDayCounter');
    const partitionRecordsCount = document.getElementById('partitionRecordsCount');
    const timeLeft = document.getElementById('timer');
    const levelDisplay = document.getElementById('levelDisplay');

    const grid = document.getElementById('grid');
    const menu = document.getElementById('menu');

    let currentContract = {}
    let acceptableContracts = {}

    const saftey = {
        guiMenuHidden: true,
        guiMenuInventory: false,
        guiMenuShop: false,
        partitionRecords: 0,
        ticks: 0,
        timeMeasuringTicks: 0,
        day: 1,
        level: 1,
        currentExp: 0,
        expNeeded: 10,
        lastSoldItem: '',
        paused: false,
        truePaused: false,
        cellIDs: [],
        hacking: false,
        locked: false,
        heatMeter: 0,
        maxHeat: 100,
        clickedCell: '',
        addToInventory(item){
            if(inventory[item] == undefined){
                inventory[item] = 1
            } else {
                inventory[item] += 1
            }
        },

        removeFromInventory(item){
            for(i = 0; i < Object.keys(inventory).length; i++){
                if(inventory[item] > 1){
                    inventory[item] -= 1
                } else {
                    delete inventory[item]
                }
            }
        }
    }

    let inventory = {}
    let dayLocked = 0



    // calculate the number of seconds until the next day

    let seconds = Math.round((1200 - (saftey.ticks % 1200)) * 125 / 1000);

    nextDayCounter.innerHTML = `Day ${saftey.day + 1} in ${seconds} second${seconds == 1 ? '' : 's'}`;


    setInterval(() => {
        if(!saftey.paused){
            saftey.ticks++;
            if(!saftey.locked){
                if(saftey.heatMeter >= saftey.maxHeat){
                    saftey.locked = true
                    dayLocked = saftey.day
                }
                if(saftey.heatMeter > 0){
                    if(saftey.ticks % 36 == 0) saftey.heatMeter--
                }
            }
            if(saftey.locked){
                if(saftey.day == dayLocked + 1){
                    saftey.locked = false
                    saftey.heatMeter = 0;
                }
            }
            partitionRecordsCount.innerHTML = `Partition Records: ${saftey.partitionRecords}`;
            if(saftey.ticks % 1200 == 0){
                saftey.day++;
                dayCounter.innerHTML = `Day ${saftey.day}`;
                saftey.heatMeter -= Math.round(saftey.maxHeat/2);
                if(saftey.heatMeter < 0) saftey.heatMeter = 0
                
            } else {
                seconds = Math.round((1200 - (saftey.ticks % 1200)) * 125 / 1000);
                nextDayCounter.innerHTML = `Day ${saftey.day + 1} in ${seconds} second${seconds == 1 ? '' : 's'}`;
            }
        }
        let contractorList = Object.keys(contractList)
        
        if(!saftey.truePaused){
            saftey.timeMeasuringTicks++;
        }
        while(saftey.currentExp >= saftey.expNeeded){
            saftey.level++;
            saftey.currentExp -= saftey.expNeeded;
            maxHeat += 10;
            saftey.expNeeded = Math.round(Math.pow(saftey.expNeeded, 1.1));
        }
        levelDisplay.innerHTML = `Level ${saftey.level} (${saftey.currentExp}/${saftey.expNeeded})`;
        heatDisplay.innerHTML = `Heat: ${saftey.heatMeter}/${saftey.maxHeat}`;
    }, 125);


    function buy(item){
        if(saftey.hacking || saftey.locked) return `You cannot do this right now!`
        if(saftey.level < technicals[item].levelReq) return `You need to be level ${technicals[item].levelReq} to buy this!`;
        if(saftey.partitionRecords >= shop[item].price){
            saftey.partitionRecords -= shop[item].price;
            if(inventory[switcher.StL[item]]){
                inventory[switcher.StL[item]]++;
            } else {
                inventory[switcher.StL[item]] = 1;
            }
            return `Successfully bought ${item}!`;
        } else {
            return `You do not have enough Partition Records to buy ${item}.`
        }
    }

    function sell(item){
        if(saftey.hacking || saftey.locked) return `You cannot do this right now!`
        let type = ''
        if(item[0] == 'h'){
            type = "Hacked "
        } else if(item[0] == 'f'){
            type = 'Failed '
        } else {
            type = ''
        }
        if(item.length == 5){
            item = item.slice(1);
        }
        
        let baseItem = item
        item = `${type}${switcher.StL[item]}`

        if(inventory[item]){
            if(inventory[item] == 0) delete inventory[item];
            inventory[item]--;
            if(inventory[item] == 0) delete inventory[item];
            let sellPrice = 0;
            if(type == 'Hacked '){
                saftey.partitionRecords += Math.round(shop[baseItem].price * 2);
                sellPrice = Math.round(shop[baseItem].price * 2);
            } else {
                saftey.partitionRecords += Math.round(shop[baseItem].price * 0.5);
                sellPrice = Math.round(shop[baseItem].price * 0.5);
            }
            saftey.lastSoldItem = item;
            return `Sold ${item} for ${sellPrice} Partition Record${sellPrice == 1 ? "" : 's'}.`
        } else {
            return `You do not have any ${item} to sell.`
        }
    }


    function hack(item){
        if(saftey.locked) return 'You cannot do this right now!'
        // check if the item is in the inventory
        if(inventory[switcher.StL[item]]){
            if(!saftey.hacking){
                let startTime = saftey.timeMeasuringTicks;
                saftey.paused = true;
                saftey.hacking = true;
                let correctOrder = true;
                saftey.truePaused = true;
                saftey.cellIDs = []
                for(i = 0; i < technicals[item].gridSize; i++){
                    for(j = 0; j < technicals[item].gridSize; j++){
                        let cell = document.createElement('div');
                        cell.id = `(${j},${i})`;
                        saftey.cellIDs.push(cell.id);
                        cell.style.border = '1px solid black';
                        cell.style.fontSize = '20px';

                        grid.setAttribute('style', `grid-template-columns: repeat(${technicals[item].gridSize}, ${500 / technicals[item].gridSize}px)`);

                        grid.appendChild(cell);
                    }
                }
                grid.removeAttribute('class');
                // add a click event listener to each cell


                let randomIndexes = [];
                while(randomIndexes.length < technicals[item].puzzleLength){
                    let randomIndex = Math.floor(Math.random() * saftey.cellIDs.length);
                    if(!randomIndexes.includes(saftey.cellIDs[randomIndex])){
                        randomIndexes.push(saftey.cellIDs[randomIndex]);
                    }
                }
                // insert the number order into the cells

                saftey.clickedCells = [];
                // continuously check if the current time is greater than the start time + the time it takes to hack the item
                for(i = 0; i < randomIndexes.length; i++){
                    document.getElementById(randomIndexes[i]).innerHTML = i + 1;
                }
                grid.removeAttribute('class');
                saftey.removeFromInventory(switcher.StL[item])

                let timer = setInterval(() => {
                    timeLeft.removeAttribute('class');
                    timeLeft.innerHTML = `Time left: ${Math.round((technicals[item].timeLimit * 1000 / 125 - (saftey.timeMeasuringTicks - startTime)) * 125 / 1000)}`
                    if(technicals[item].timeLimit * 1000 / 125 <= saftey.timeMeasuringTicks - startTime){
                        saftey.paused = false;
                        saftey.hacking = false;
                        grid.setAttribute('class', 'hidden');
                        grid.innerHTML = '';
                        timeLeft.setAttribute('class', 'hidden');
                        timeLeft.innerHTML = '';
                        clearInterval(timer)
                        return console.log(`Failed to hack ${switcher.StL[item]}.`)
                    }
                }, 1)
                for(i = 0; i < saftey.cellIDs.length; i++){
                    document.getElementById(saftey.cellIDs[i]).addEventListener('click', () => {
                        saftey.truePaused = false;
                        for(i = 0; i < randomIndexes.length; i++){
                            document.getElementById(randomIndexes[i]).innerHTML = '';
                        }

                        saftey.clickedCells.push(event.target.id);
                        if(saftey.clickedCells.length == randomIndexes.length){
                            for(i = 0; i < randomIndexes.length; i++){
                                if(randomIndexes[i] == saftey.clickedCells[i]){
                                    correctOrder = true;
                                } else {
                                    saftey.paused = false;
                                    saftey.hacking = false;
                                    grid.setAttribute('class', 'hidden');
                                    grid.innerHTML = '';
                                    timeLeft.setAttribute('class', 'hidden');
                                    timeLeft.innerHTML = '';
                                    clearInterval(timer)
                                    return console.log(`Failed to hack ${switcher.StL[item]}.`)
                                }
                            }
                            if(correctOrder){
                                saftey.paused = false;
                                saftey.hacking = false;
                                grid.setAttribute('class', 'hidden');
                                grid.innerHTML = '';
                                timeLeft.setAttribute('class', 'hidden');
                                timeLeft.innerHTML = '';
                                saftey.addToInventory('Hacked ' + switcher.StL[item])
                                let time = Math.round((saftey.timeMeasuringTicks - startTime) * 125 / 1000)

                                saftey.currentExp += technicals[item].exp;
                                saftey.heatMeter += technicals[item].heat
                                clearInterval(timer)
                                return console.log(`Successfully hacked ${switcher.StL[item]} in a time span of ${time} second${time == 1 ? '' : 's'}!`)
                            }
                        }
                    })
                }
            }

        } else {
            let status = ''
            if(item[0] == 'h' || item[0] == 'f'){
                status = item[0];
                item = item.slice(1);
                return `Cannot hack ${switcher.StL[status]} ${switcher.StL[item]}.`

            }
            return `You do not have any ${switcher.StL[item].replace('Partition', 'Partitions')}.`
        }
        return `Hacking ${switcher.StL[item]}...`
    }

    // convert ticks to seconds
    

    saftey.addToInventory('Unsecure Bitram Partition Mk. 1')
</script>