<style>
    html {
        font-family: monospace;
        user-select: none;
    }
    textarea {
        resize: none;
    }
    textarea:focus {
        outline: none;
    }
    #ui-grid {
        display: grid;
        grid-template-rows: repeat(2, 360px);
        grid-template-columns: repeat(1, 98vw);
        column-gap: 20px;
        row-gap: 20px;
    
    }
</style>
<head>
    <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
</head>
<body>
    <a href="Rustype3-docs.txt" download="Rustype3-docs">
        <button position="absolute;">Download Docs</button>
    </a><br><br>
    <!--1 textarea row = 12px-->
    <div id="ui-grid">
        <textarea id="input" rows="30" cols="100" autocomplete="off" spellcheck="false" title="code editor" style="width: 98vw; user-select: initial;" contentEditable="true"></textarea>
        <textarea id="console" rows="30" cols="100" readonly spellcheck="false" title="code output" style="width: 98vw; user-select: none;"></textarea>
    </div>
</body>
<script>
const input = document.getElementById("input")
const appConsole = document.getElementById("console")

const system = {
    getType(tester) {
        if(checkIfEnclosed(tester,'"','"')){
            return "string"
        } else if (!isNaN(tester) && tester.indexOf(".") == -1){
            return "int"
        } else if(system.variables.find(x => x.name == tester)){
            return "ref"
        } else {
            return undefined
        }
    },
    console: {
        log: function(message) {
            appConsole.value += message + "\n"
        },
        clear: function() {
            appConsole.value = ''
        }
    },
    keywords: ["set", "log", "def", "run"],
    variables: [],
    functionsArray: [],
    call: function(variableName) {
        if(system.variables.find(x => x.name == variableName)){
            return system.variables.find(x => x.name == variableName).value
        } else {
            return undefined
        }
    },
    types: ["string", "int", "variable_ref"]
    
}


function checkIfEnclosed(string, leftEncloser, rightEncloser){
    return Boolean (string[0] == leftEncloser && string[string.length - 1] == rightEncloser)
}

hotkeys.filter = function(event) {
  var target = event.target || event.srcElement;
  var tagName = target.tagName;
  return !(target.isContentEditable || tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');
}

hotkeys.filter = function(event){
  var tagName = (event.target || event.srcElement).tagName;
  hotkeys.setScope(/^(INPUT|TEXTAREA|SELECT)$/.test(tagName) ? 'input' : 'other');
  return true;
}

hotkeys('ctrl+r', function(event, handler) {
  event.preventDefault();
  run(input.value, false)
});

function run(code, runWithFunction) {
    let codeBlock;
    if(runWithFunction == false){
        system.console.clear()
        system.variables = []
    }

    codeBlock = code.split("\n")
    for(i = 0; i < codeBlock.length; i++){
        let line = codeBlock[i].trim().split(" ")
        let providedKeyword = line[0].trim()
        if(!system.keywords.includes(providedKeyword)){
            system.console.log(`Syntax Error: Unknown keyword (line ${i+1})`)
        } else {
            if(providedKeyword == system.keywords[0]){
                let varName = line[1]
                let assignment_operator = line[line.indexOf("=")]
                let varType;
                let varValue;
                varValue = line.join(" ").split(`${assignment_operator} `)[1]
                if(checkIfEnclosed(varValue,'"','"')){
                    varType = "string"
                } else if (!isNaN(varValue) && varValue.indexOf(".") == -1){
                    varType = "int"
                } else {
                    if(system.variables.find(x => x.name == varValue) == undefined){
                        system.console.log(`Syntax Error: Variable "${varValue}" is not defined (line ${i+1})`)
                    } else {
                        varType = system.variables.find(x => x.name == varValue).type
                        varValue = system.variables.find(x => x.name == varValue).value
                    }
                }
                system.variables.push({name: varName, type: varType, value: varValue})
            }
            if(providedKeyword == system.keywords[1]){
                if(line.length != 2){
                    system.console.log(`Syntax Error: Incomplete line (line ${i+1})`)
                } else {
                    let providedArgument = line[1]
                    switch(system.getType(providedArgument)){
                        case "int":
                            system.console.log(providedArgument)
                        break
                        case "string":
                            system.console.log(providedArgument)
                        break
                        case "ref":
                            if(system.variables.find(x => x.name == providedArgument) == undefined){
                                system.console.log(`Syntax Error: Variable "${providedArgument}" is not defined (line ${i+1})`)
                            } else {
                                system.console.log(system.variables.find(x => x.name == providedArgument).value)
                            }
                        break;
                    }
                }
            }
            if(providedKeyword == system.keywords[2]){
                let appFunction = [line[1], line.slice(2).join(" ")]
                if(appFunction.length != 2){
                    system.console.log(`Syntax Error: Incomplete line (line ${i+1})`)
                } else {
                    if(!checkIfEnclosed(appFunction[1], "{", "}")){
                        system.console.log(`Syntax Error: Incomplete line (line ${i+1})`)
                    } else {
                        let functionBody = appFunction[1].replaceAll("{ ", "").replaceAll(" }", "").split(", ")
                        system.functionsArray.push({[line[1]] : functionBody})
                    }
                }
            }
            if(providedKeyword == system.keywords[2]){
                let functionToExecute = line[1]
                if(appFunction.length != 2){
                    system.console.log(`Syntax Error: Incomplete line (line ${i+1})`)
                } else {
                    if(!checkIfEnclosed(appFunction[1], "{", "}")){
                        system.console.log(`Syntax Error: Incomplete line (line ${i+1})`)
                    } else {
                        let functionBody = appFunction[1].replaceAll("{ ", "").replaceAll(" }", "").split(", ")
                        system.functionsArray.push(functionBody)
                    }
                }
            }
        }
    }
}

</script>