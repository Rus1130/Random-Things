<style>

</style>
<head>

</head>
<body>
    <script src="two.js"></script>
</body>
<script>
    var two = new Two({
        fullscreen: true,
        autostart: true
    }).appendTo(document.body);

    const gameData = {
        gridLines: [],
        zoom: 0.7,
        zoomMultiplier: 40,
        mouseX: 0,
        mouseY: 0,
        redrawGrid: false,
        objects: [],
        keys: {},
        showGrid: false,
    }

    let placementPreview = two.makeRoundedRectangle(0, 0, gameData.zoomMultiplier, gameData.zoomMultiplier, 4);
    placementPreview.fill = 'black';
    placementPreview.opacity = 0.5;


    function getPreviewCoordinates(){
        return {x: placementPreview.translation.x, y: placementPreview.translation.y};
    }


    const place = {
        circle(x, y, radius){
            let circle = two.makeCircle(x, y, radius);
            circle.fill = 'red';
            circle.objectType = 'circle';
            gameData.objects.push(circle);
        },
    }

    
    let zoomText = two.makeText("Zoom: " + gameData.zoom, 20, window.innerHeight - 20, {
        size: 20,
        family: 'Arial',
        fill: 'black',
        alignment: 'left',
    });

    document.onmousemove = e => {
        gameData.mouseX = e.clientX;
        gameData.mouseY = e.clientY;
    }

    function setGridLines(){
        gameData.gridLines.forEach(line => {
            line.remove();
        });


        for(let i = 0; i < window.innerWidth; i += (gameData.zoom * gameData.zoomMultiplier)){
            let line = two.makeLine(i, 0, i, window.innerHeight);
            line.stroke = 'black';
            line.linewidth = 1;
            line.direction = 'horizontal';

            gameData.gridLines.push(line);
        }

        for(let i = 0; i < window.innerHeight; i += (gameData.zoom * gameData.zoomMultiplier)){
            let line = two.makeLine(0, i, window.innerWidth, i);
            line.stroke = 'black';
            line.linewidth = 1;
            line.direction = 'vertical';

            gameData.gridLines.push(line);
        }
    }

    function redrawAllObjects(){
        placementPreview.width = gameData.zoomMultiplier * gameData.zoom;
        placementPreview.height = gameData.zoomMultiplier * gameData.zoom;

        gameData.objects.forEach(object => {

            let x = object.translation.x;
            let y = object.translation.y;

            x = Math.round(x / (gameData.zoomMultiplier * gameData.zoom)) * (gameData.zoomMultiplier * gameData.zoom);
            y = Math.round(y / (gameData.zoomMultiplier * gameData.zoom)) * (gameData.zoomMultiplier * gameData.zoom);

            object.translation.set(x, y);


            if(object.objectType == 'circle'){
                object.radius = gameData.zoomMultiplier * gameData.zoom / 2;
            }
        })


        
        gameData.redrawGrid = false;
    }

    document.onkeydown = e => {
        let key = e.key
        gameData.keys[key] = true;

        if(gameData.keys['ArrowUp']){
            gameData.zoom += 0.1;
            gameData.redrawGrid = true;
        }
        if(gameData.keys['ArrowDown']){
            // only zoom in more if the zoom is greater than 0.1
            if(gameData.zoom > 0.1){
                gameData.zoom -= 0.1;
                gameData.redrawGrid = true;
            }
        }
    }


    document.onkeyup = e => {
        let key = e.key
        gameData.keys[key] = false;
    }

    document.onmouseup = e => {
        let button = e.button;
        if(button == 0){
            place.circle(getPreviewCoordinates().x, getPreviewCoordinates().y, gameData.zoomMultiplier * gameData.zoom / 2);
        }
    }

    function update(fc){
        let x = gameData.mouseX;
        let y = gameData.mouseY;

        // make it snap to grid squares

        x = Math.round(x / (gameData.zoomMultiplier * gameData.zoom)) * (gameData.zoomMultiplier * gameData.zoom);
        y = Math.round(y / (gameData.zoomMultiplier * gameData.zoom)) * (gameData.zoomMultiplier * gameData.zoom);
        
        placementPreview.translation.set(x, y);

        if(gameData.redrawGrid){
            if(gameData.showGrid) setGridLines();

            redrawAllObjects()

        } 

        zoomText.translation.set(20, window.innerHeight - 20);
        zoomText.value = "Zoom: " + (gameData.zoom + 0.3).toFixed(1) + "x";
    }

    two.bind('update', function(frameCount) {
        update(frameCount);
    })

    window.onresize = e => {
        gameData.redrawGrid = true;
        update();
    }

    if(gameData.showGrid) setGridLines();
</script>