<style>
    html {
        font-family: monospace;
        user-select: none;
        font-size: 18px;
        margin: 0px;
    }
    input:focus {
        outline: none;
    }
    .visible {
        display: initial;
    }
    .invisible {
        display: none;
    }
    #btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: monospace;
        border: 1px black solid;
        border-radius: 2px;
        font-size: 15px;
        background-color: beige;
    }

</style>
<head>
    <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
</head>
<body>
    <div id="setup-container">
        Gameboard Rows: <input type="number" id="board-rows" min="8" max="32" value="16"><br>
        Gameboard Columns: <input type="number" id="board-columns" min="8" max="64" value="32"><br>
        Partitions: <input type="number" id="partition-amount" min="2" max="16" value="8"><br>
        Controls: WASD to move, arrow keys to buy bitram partition miners.<br><br>
        The letters "F", "C", "B", "A", and "S" are exposed bitram partitions.<br>If you go to the exposed bitram partition and press the arrow key in that direction, it will place a bitram miner.
        <button id="btn" onclick="setup()">New Game</button>
    </div>
    <div id="ui-container" class="invisible">
        <button id="btn" onclick="reset()">Back to Menu</button>
        <span style="font-size: 20px">Bitram: <span id=bitram-display></span>Ȣ</span><br> <!--¤-->
        <div id="alert-box"></div>
    </div>
    <br>
    <div id="top-border"></div>
    <div id="game-space"></div>
    <div id="bottom-border"></div>
</body>

<script>

const bkgd = "&nbsp;" // &nbsp; test: ▒
const setupContainer = document.getElementById("setup-container")
let gamespace = document.getElementById("game-space")
const alertBox = document.getElementById("alert-box")
const partitionAmount = document.getElementById("partition-amount")
const rowsInput = document.getElementById("board-rows")
const colsInput = document.getElementById("board-columns")
const bitramDisplay = document.getElementById("bitram-display")

const rowMin = 8
const rowMax = 32
const colMin = 8
const colMax = 64
const partMin = 2
const partMax = 16
let bitramProduction = 0;

let gameboard = [];
let straightFrame = [];
let partitions = []
const randomizer = (values) => {
    let i, pickedValue, 
    randomNr = Math.random(),
    threshold = 0;
    for (i = 0; i < values.length; i++) {
        if (values[i].probability === '*'){ 
            continue;
        }
        threshold += values[i].probability; 
        if(threshold > randomNr) {
            pickedValue = values[i].value;
            break;
        }
        if (!pickedValue) {
            pickedValue = values.filter((value) => value.probability === '*');
        }
    }
    return pickedValue;
}

const partitionMiners = {
    S: {cost: 800, production: 600},
    A: {cost: 400, production: 200},
    B: {cost: 300, production: 50},
    C: {cost: 200, production: 10},
    F: {cost: 100, production: 5}
}

const partitionRarity = [{
        value : 'F',
        probability : 0.5
    },
    {
        value : 'C',
        probability : 0.25
    },
    {
        value : 'B',
        probability : 0.125
    },
    {
        value : 'A',
        probability : 0.09375
    },
    {
        value : 'S',
        probability : 0.03125
    }
]

let state = "setup";

let player = {
    sprite: "█",
    x: "",
    y: "",
    bitram: 100,
    production: 0
}

function random(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1) + min);
}

function reset(){
    location.reload()
}

function setup(){
    if(state != "setup"){} else {
        if(parseInt(rowsInput.value) > rowMax || parseInt(rowsInput.value) < rowMin || parseInt(colsInput.value) > colMax || parseInt(rowsInput.value) < colMin || parseInt(partitionAmount.value) > partMax || parseInt(partitionAmount.value) < partMin){
            alert("Invalid Setup Values")
        } else {

            if(parseInt(rowsInput.value) == "" || parseInt(colsInput.value) == "" || parseInt(partitionAmount.value) == ""){
                alert("Please fill out all fields.")
            } else {
                document.getElementById("ui-container").removeAttribute("class","invisible")
                document.getElementById("setup-container").setAttribute("class","invisible")
                for (i = 0; i < parseInt(rowsInput.value); i++) {
                    gameboard.push([]);
                    for (j = 0; j < parseInt(colsInput.value); j++) {
                        gameboard[i].push(bkgd);
                    }
                }
                for(k = 0; k < gameboard[0].length; k++){
                    straightFrame.push("═")
                    
                }
                for(l = 0; l < parseInt(partitionAmount.value) - 1; l++){
                    let partitionY = random(3, gameboard.length - 5)
                    let partitionX = random(3, gameboard[partitionY].length - 5)
                    partitions.push({
                            quality: randomizer(partitionRarity),
                            x: partitionX,
                            y: partitionY
                        }
                    )
                }
                let gY = random(3, gameboard.length - 5)
                let gX = random(3, gameboard[gY].length - 5)
                partitions.push({
                            quality: "F",
                            x: gX,
                            y: gY
                        }
                    )
                document.getElementById("top-border").innerHTML = "╔" + straightFrame.join("") + "╗"
                document.getElementById("bottom-border").innerHTML = "╚" + straightFrame.join("") + "╝"
                player.y = random(0, gameboard.length)
                player.x = random(0, gameboard[player.y].length - 1)
                for(i = 0; i < partitions.length; i++){
                    gameboard[partitions[i].y][partitions[i].x] = partitions[i].quality
                }
                gamespace.innerHTML = JSON.stringify(gameboard).replaceAll("],[","║<br>║").replace("[[","║").replace("]]","║").replaceAll('"',"").replaceAll(",","")
                state = "play"
            }
        }
    }
}

setInterval(() => {
    if(state != "play"){} else {
        player.bitram += player.production
    }
}, 3000)

hotkeys('w,a,s,d,up,down,left,right', function (event, handler){
    switch (handler.key){
        case 'w':
            if(state != "play"){} else {
                if(player.y > 0){
                    if( gameboard[player.y - 1][player.x] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.y -= 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 'a':
            if(state != "play"){} else {
                if(player.x > 0){
                    if(gameboard[player.y][player.x - 1] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.x -= 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 's':
            if(state != "play"){} else {
                if(player.y < gameboard.length - 1){
                    if(gameboard[player.y + 1][player.x] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.y += 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 'd':
            if(state != "play"){} else {
                if(player.x < gameboard[0].length - 1){
                    if(gameboard[player.y][player.x + 1] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.x += 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case "up":
            if(state != "play"){} else {
                if(gameboard[player.y - 1][player.x].charCodeAt(0) < 65 || gameboard[player.y - 1][player.x].charCodeAt(0) > 83){
                    alertBox.innerHTML = "You cannot place a Bitram Miner here!"
                } else {
                    if(player.bitram < partitionMiners[gameboard[player.y - 1][player.x]].cost){
                        alertBox.innerHTML = "You don't have enough bitram to place a Bitram Miner!"
                    } else {
                        player.bitram -= partitionMiners[gameboard[player.y - 1][player.x]].cost
                        player.production += partitionMiners[gameboard[player.y - 1][player.x]].production
                        gameboard[player.y - 1][player.x] = "¤"
                    }
                }
            }
        break;
        case "left":
            if(state != "play"){} else {
                if(gameboard[player.y][player.x - 1].charCodeAt(0) < 65 || gameboard[player.y][player.x - 1].charCodeAt(0) > 83){
                    alertBox.innerHTML = "You cannot place a Bitram Miner here!"
                } else {
                    if(player.bitram < partitionMiners[gameboard[player.y][player.x - 1]].cost){
                        alertBox.innerHTML = "You don't have enough bitram to place a Bitram Miner!"
                    } else {
                        player.bitram -= partitionMiners[gameboard[player.y][player.x - 1]].cost
                        player.production += partitionMiners[gameboard[player.y][player.x - 1]].production
                        gameboard[player.y][player.x - 1] = "¤"
                    }
                }
            }
        break;
        case "down":
            if(state != "play"){} else {
                if(gameboard[player.y + 1][player.x].charCodeAt(0) < 65 || gameboard[player.y + 1][player.x].charCodeAt(0) > 83){
                    alertBox.innerHTML = "You cannot place a Bitram Miner here!"
                } else {
                    if(player.bitram < partitionMiners[gameboard[player.y + 1][player.x]].cost){
                        alertBox.innerHTML = "You don't have enough bitram to place a Bitram Miner!"
                    } else {
                        player.bitram -= partitionMiners[gameboard[player.y + 1][player.x]].cost
                        player.production += partitionMiners[gameboard[player.y + 1][player.x]].production
                        gameboard[player.y + 1][player.x] = "¤"
                    }
                }
            }
        break;
        case "right":
            if(state != "play"){} else {
                if(gameboard[player.y][player.x + 1].charCodeAt(0) <= 65 || gameboard[player.y][player.x + 1].charCodeAt(0) >= 83){
                    alertBox.innerHTML = "You cannot place a Bitram Miner here!"
                } else {
                    if(player.bitram < partitionMiners[gameboard[player.y][player.x + 1]].cost){
                        alertBox.innerHTML = "You don't have enough bitram to place a Bitram Miner!"
                    } else {
                        player.bitram -= partitionMiners[gameboard[player.y][player.x + 1]].cost
                        player.production += partitionMiners[gameboard[player.y][player.x + 1]].production
                        gameboard[player.y][player.x + 1] = "¤"
                    }
                }
            }
        break;
    }
});


function boardUpdate(){
    if(state != "play"){} else {
        gameboard[player.y][player.x] = player.sprite
        bitramDisplay.innerHTML = player.bitram
        gamespace.innerHTML = JSON.stringify(gameboard).replaceAll("],[","║<br>║").replace("[[","║").replace("]]","║").replaceAll('"',"").replaceAll(",","")
        
    }
}

setInterval(() => boardUpdate(), 16.67)

</script>