<style>
    html {
        font-family: monospace;
        user-select: none;
        font-size: 18px;
        margin: 0px;
    }
    input:focus {
        outline: none;
    }
    .visible {
        display: initial;
    }
    .invisible {
        display: none;
    }
    #btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: monospace;
        border: 1px black solid;
        border-radius: 2px;
        font-size: 15px;
        background-color: beige;
    }

</style>
<head>
    <script src="https://unpkg.com/hotkeys-js/dist/hotkeys.min.js"></script>
</head>
<body>
    <div id="setup-container">
        Gameboard Rows: <input type="number" id="board-rows" min="8" max="32" value="16"><br>
        Gameboard Columns: <input type="number" id="board-columns" min="8" max="64" value="32"><br>
        <button id="btn" onclick="setup()">New Game</button>
    </div>
    <div id="ui-container" class="invisible">
        <button id="btn" onclick="reset()">Back to Menu</button>
        <div id="alert-box"></div>
    </div>
    <br>
    <div id="top-border"></div>
    <div id="game-space"></div>
    <div id="bottom-border"></div>
</body>

<script>

const bkgd = "&nbsp;" // &nbsp; test: ▒
const setupContainer = document.getElementById("setup-container")
let gamespace = document.getElementById("game-space")
const alertBox = document.getElementById("alert-box")
const rowsInput = document.getElementById("board-rows")
const colsInput = document.getElementById("board-columns")

const rowMin = 8
const rowMax = 32
const colMin = 8
const colMax = 64

let gameboard = [];
let straightFrame = [];
const randomizer = (values) => {
    let i, pickedValue, 
    randomNr = Math.random(),
    threshold = 0;
    for (i = 0; i < values.length; i++) {
        if (values[i].probability === '*'){ 
            continue;
        }
        threshold += values[i].probability; 
        if(threshold > randomNr) {
            pickedValue = values[i].value;
            break;
        }
        if (!pickedValue) {
            pickedValue = values.filter((value) => value.probability === '*');
        }
    }
    return pickedValue;
}



let state = "setup";

let player = {
    sprite: "╧",
    x: "",
    y: "",
    state: "facing-up"
}

function random(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1) + min);
}

function reset(){
    location.reload()
}

let bullets = []


function setup(){
    if(state != "setup"){} else {
        if(parseInt(rowsInput.value) > rowMax || parseInt(rowsInput.value) < rowMin || parseInt(colsInput.value) > colMax || parseInt(rowsInput.value) < colMin){
            alert("Invalid Setup Values")
        } else {

            if(parseInt(rowsInput.value) == "" || parseInt(colsInput.value) == ""){
                alert("Please fill out all fields.")
            } else {
                document.getElementById("ui-container").removeAttribute("class","invisible")
                document.getElementById("setup-container").setAttribute("class","invisible")
                for (i = 0; i < parseInt(rowsInput.value); i++) {
                    gameboard.push([]);
                    for (j = 0; j < parseInt(colsInput.value); j++) {
                        gameboard[i].push(bkgd);
                    }
                }
                for(k = 0; k < gameboard[0].length; k++){
                    straightFrame.push("═")
                    
                }

                document.getElementById("top-border").innerHTML = "╔" + straightFrame.join("") + "╗"
                document.getElementById("bottom-border").innerHTML = "╚" + straightFrame.join("") + "╝"
                player.y = random(0, gameboard.length)
                player.x = random(0, gameboard[player.y].length - 1)

                gamespace.innerHTML = JSON.stringify(gameboard).replaceAll("],[","║<br>║").replace("[[","║").replace("]]","║").replaceAll('"',"").replaceAll(",","")
                state = "play"
            }
        }
    }
}

hotkeys('w,a,s,d,space', function (event, handler){
    switch (handler.key){
        case 'w':
            if(state != "play"){} else {
                if(player.y > 0){
                    if(gameboard[player.y - 1][player.x] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.state = "facing-up"
                        player.sprite = "╧"
                        player.y -= 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 'a':
            if(state != "play"){} else {
                if(player.x > 0){
                    if(gameboard[player.y][player.x - 1] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.sprite = "╢"
                        player.state = "facing-left"
                        player.x -= 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 's':
            if(state != "play"){} else {
                if(player.y < gameboard.length - 1){
                    if(gameboard[player.y + 1][player.x] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.sprite = "╤"
                        player.state = "facing-down"
                        player.y += 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 'd':
            if(state != "play"){} else {
                if(player.x < gameboard[0].length - 1){
                    if(gameboard[player.y][player.x + 1] != "&nbsp;"){} else {
                        gameboard[player.y][player.x] = bkgd
                        player.sprite = "╟"
                        player.state = "facing-right"
                        player.x += 1;
                        alertBox.innerHTML = ''
                    }
                }
            }
        break;
        case 'space':
            if(state != "play"){} else {
                switch(player.state){
                    case "facing-up":
                        bullets.push({y: parseInt(player.y - 1), x: parseInt(player.x), sprite: "╎", state: "up"})
                    break;
                    case "facing-left":
                        bullets.push({y: parseInt(player.y), x: parseInt(player.x - 1), sprite: "╌", state: "left"})
                    break;
                    case "facing-down":
                        bullets.push({y: parseInt(player.y + 1), x: parseInt(player.x), sprite: "╎", state: "down"})
                    break;
                    case "facing-left":
                        bullets.push({y: parseInt(player.y), x: parseInt(player.x + 1), sprite: "╌", state: "left"})
                    break;
                }
            }
    }
});

setInterval(() => {
    for( i = 0; i < bullets.length; i++){
        switch(bullets[i].state){
            case "up":
                gameboard[bullets[i].y][bullets[i].x] = bkgd
                bullets[i].y -= 1
                if(bullets[i].y > 0){
                    gameboard[bullets[i].y][bullets[i].x] = bkgd
                }
            break;
        }
    }
}, 100)

function boardUpdate(){
    if(state != "play"){} else {
        for( i = 0; i < bullets.length; i++){
            gameboard[bullets[i].y][bullets[i].x] = bullets[i].sprite
        }
        gameboard[player.y][player.x] = player.sprite

        gamespace.innerHTML = JSON.stringify(gameboard).replaceAll("],[","║<br>║").replace("[[","║").replace("]]","║").replaceAll('"',"").replaceAll(",","")
        
    }
}

setInterval(() => boardUpdate(), 16.67)

</script>