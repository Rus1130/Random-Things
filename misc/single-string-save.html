<style>
    #player {
        width: 50px;
        height: 50px;
        background-color: red;
        position: absolute;
        border-radius: 50%;
        top: 0;
        left: 0;
        z-index: 10;
    }

    body {
        overflow: hidden;
    }

    #key-wrapper, #key-input-wrapper {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: fit-content;
        height: fit-content;
        border: 1px solid black;
        padding: 10px;
        display: none;
        background-color: white;
    }

    #copy-key-button, #set-key-button {
        cursor: pointer;
        margin-top: -10px;
        text-align: center;
        background-color: #f0f0f0;
        padding: 5px;
        border: 1px solid black;
        user-select: none;
    }

    #key-input {
        border: 1px solid black;
        padding: 5px;
    }

    #key-input:focus {
        outline: none;
    }

    #inventory {
        position: absolute;
        top: 0;
        left: 0;
        padding: 10px;
        border: 1px solid black;
    }

</style>
<head>
    <script src="../shooter/math.js"></script>
    <script src="../computers/encryption.js"></script>
</head>
<body>
    <div id="field">
        <div id="player" style="background-color: red;"></div>
    </div>
    <div id="inventory">
        <div id="coin-counter">Coins: 0</div>
        <div id="red-circle-counter">Red Circles: 0</div>
        <div id="blue-circle-counter">Blue Circles: 0</div>
        <div id="green-circle-counter">Green Circles: 0</div><br>
        P and O to show/hide key and input
    </div>
    <div id="key-wrapper">
        Your key:<br>
        <div id="key">#####</div>
        <br>
        <div id="copy-key-button" onclick="copyKeyToClipboard()">Copy Key</div>
    </div>
    <div id="key-input-wrapper">
        Input key here: <div id="key-input" contenteditable="true"></div>
        <br>
        <div id="set-key-button" onclick="setKey(keyInput.innerText)">submit</div>
    </div>
    </div>
</body>
<script>

    let e = new Encryption();

    let data = {
        x: window.innerWidth / 2,
        y: window.innerHeight / 2,
        vx: 0,
        vy: 0,
        color: "red",
        inventory: {
            coins: 0,
            redCircle: 0,
            blueCircle: 0,
            greenCircle: 0,
        },
        xp: 0,
        keys: {}
    }
    const player = document.getElementById('player');

    const keyDisplay = document.getElementById('key-wrapper');
    const inputDisplay = document.getElementById('key-input-wrapper');
    const keyInput = document.getElementById('key-input');
    const rawKey = document.getElementById('key');

    const inventory = document.getElementById('inventory');

    // create random circles on the field

    const circleAmount = 1000;
    for(let i = 0; i < circleAmount; i++){
        let circle = document.createElement('circle');
        circle.style.width = "25px";
        circle.style.height = "25px";
        circle.style.backgroundColor = i < circleAmount / 3 ? "blue" : i < (circleAmount / 3) * 2 ? "green" : "red";
        circle.style.position = "absolute";
        circle.style.borderRadius = "50%";

        let randomX = math.random(0, window.innerHeight - 25);
        let randomY = math.random(0, window.innerWidth - 25);

        while(randomX < inventory.clientHeight && randomY < inventory.clientWidth){
            randomX = math.random(0, window.innerHeight - 25);
            randomY = math.random(0, window.innerWidth - 25);
        }


        circle.style.top =  randomX + "px";
        circle.style.left = randomY + "px"; 	
        circle.id = "circle" + i;
        document.getElementById('field').appendChild(circle);
    }

    function colorUpdate(){
        if(data.color == "red"){
            data.color = "green";
            player.style.backgroundColor = "green";
        }
        else if(data.color == "green") {
            data.color = "blue";
            player.style.backgroundColor = "blue";
        }
        else if(data.color == "blue") {
            data.color = "red";
            player.style.backgroundColor = "red";
        }
    }

    function update(){
        // movement
        if(data.keys["w"]) data.vy -= 1;
        if(data.keys["s"]) data.vy += 1;
        if(data.keys["a"]) data.vx -= 1;
        if(data.keys["d"]) data.vx += 1;


        data.vx = math.round(data.vx * 0.9, 4);
        data.vy = math.round(data.vy * 0.9, 4);

        data.x += data.vx;
        data.y += data.vy;

        data.x = math.round(data.x);
        data.y = math.round(data.y);

        player.style.left = data.x + "px";
        player.style.top = data.y + "px";

        if(data.x < 0) data.x = 0;
        if(data.y < 0) data.y = 0;
        if(data.x > window.innerWidth - 50) data.x = window.innerWidth - 50;
        if(data.y > window.innerHeight - 50) data.y = window.innerHeight - 50;


        // inventory
        document.getElementById('coin-counter').innerText = "Coins: " + data.inventory.coins;
        document.getElementById('red-circle-counter').innerText = "Red Circles: " + data.inventory.redCircle;
        document.getElementById('blue-circle-counter').innerText = "Blue Circles: " + data.inventory.blueCircle;
        document.getElementById('green-circle-counter').innerText = "Green Circles: " + data.inventory.greenCircle;

        // collision detection
        for(let i = 0; i < document.getElementsByTagName("circle").length; i++){
            let circle = document.getElementsByTagName("circle")[i];
            let circleX = circle.style.left.slice(0, -2);
            let circleY = circle.style.top.slice(0, -2);
            let circleWidth = circle.style.width.slice(0, -2);
            let circleHeight = circle.style.height.slice(0, -2);


            // check if player is touching a circle via getBoundingClientRect
            let playerRect = player.getBoundingClientRect();
            let circleRect = circle.getBoundingClientRect();

            if(circle.style.backgroundColor == player.style.backgroundColor){
                if(playerRect.x - 5 < circleRect.x + circleRect.width && playerRect.x - 5 + playerRect.width > circleRect.x && playerRect.y < circleRect.y + circleRect.height && playerRect.y - 5 + playerRect.height - 5 > circleRect.y){
                    circle.remove();
                    data.inventory[circle.style.backgroundColor + "Circle"]++;
                    data.inventory.coins += 10;
                    if(data.inventory.coins > 18279) data.inventory.coins = 18279;
                }
            }
        }
        

        // key creation
        let dataX = data.x.toString(26).replace("-", "").padStart(3, "0");
        let dataY = data.y.toString(26).replace("-", "").padStart(3, "0");
        let colorData = data.color == "red" ? "1" : data.color == "blue" ? "2" : "3";
        let coinData = data.inventory.coins.toString(26).replace("-", "").padStart(3, "0");
        let redData = data.inventory.redCircle.toString(26).replace("-", "").padStart(3, "0");
        let blueData = data.inventory.blueCircle.toString(26).replace("-", "").padStart(3, "0");
        let greenData = data.inventory.greenCircle.toString(26).replace("-", "").padStart(3, "0");

        rawKey.innerText = dataX + dataY + coinData + colorData + redData + blueData + greenData;
    }

    function copyKeyToClipboard(){
        let key = rawKey.innerText;
        navigator.clipboard.writeText(key);
    }

    function setKey(key){
        let x = parseInt(key.slice(0, 3), 26);
        let y = parseInt(key.slice(3, 6), 26);
        let color = parseInt(key.slice(6, 7));
        let coins = parseInt(key.slice(7, 10), 26);
        let red = parseInt(key.slice(10, 13), 26);
        let blue = parseInt(key.slice(13, 16), 26);
        let green = parseInt(key.slice(16, 19), 26);

        data.x = x;
        data.y = y;
        data.color = color == 1 ? "red" : color == 2 ? "blue" : "green";
        player.style.backgroundColor = data.color;
        data.inventory.coins = coins;
        data.inventory.redCircle = red;
        data.inventory.blueCircle = blue;
        data.inventory.greenCircle = green;

        player.style.left = data.x + "px";
        player.style.top = data.y + "px";
    }



    setInterval(update, 15); //15
    setInterval(colorUpdate, 10000); //15000

    document.addEventListener('keydown', function(event) {
        data.keys[event.key] = true;
        if(data.keys["p"]) keyDisplay.style.display = keyDisplay.style.display == "block" ? "none" : "block";
        if(data.keys["o"]) inputDisplay.style.display = inputDisplay.style.display == "block" ? "none" : "block";
    
    });

    document.addEventListener('keyup', function(event) {
        data.keys[event.key] = false;
    });
</script>