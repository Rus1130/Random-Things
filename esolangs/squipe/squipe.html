<style>
    .grid {
        display: grid;
        grid-template-columns: repeat(60, 10px);
        grid-template-rows: repeat(30, 20px);
        width: 600px;
        height: 600px;
        border: 1px solid black;
        position: absolute;
    }
    .grid-cell {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 20px;
        width: 10px;
        font-size: 18px;
        font-family: monospace;
    }
</style>
<head>
</head>
<body>
    <div id="grid" class="grid"></div>
    <div id="under-grid" class="grid"></div>
</body>
<script>
    const grid = document.getElementById("grid");
    const underGrid = document.getElementById("under-grid");

    let pointer = 0;

    function getUndergridCell(id){
        return document.getElementById("under-cell" + id)
    }
    function getGridCell(id){
        return document.getElementById("cell" + id)
    }

    for(i = 0; i < 1800; i++){
        let gridCell = document.createElement("div");
        gridCell.className = "grid-cell";
        gridCell.id = "cell" + i;
        grid.appendChild(gridCell);

        let underCell = document.createElement("div");
        underCell.className = "grid-cell";
        underCell.id = "under-cell" + i;
        underGrid.appendChild(underCell);
    }

    function updateCells(){
        for(i = 0; i < 1800; i++){
            if(i == pointer){
                if(editMode){
                    getGridCell(i).style.backgroundColor = "beige";
                } else {
                    getGridCell(i).style.backgroundColor = "indianred"; 
                }
            } else {
                getGridCell(i).style.backgroundColor = "white";
            }
        }
    }

    let squares = []

    function moveRight(){
        if(pointer % 60 != 59){
            pointer++
        } else {
            pointer -= 59
        }
    }
    function moveLeft(){
        if(pointer % 60 != 0){
            pointer--
        } else {
            pointer += 59
        }
    }
    function moveUp(){
        if(pointer > 60){
            pointer -= 60
        } else {
            pointer += 1740
        }
    }
    function moveDown(){
        if(pointer < 1740){
            pointer += 60
        } else {
            pointer -= 1740
        }
    }

    let editMode = true;

    const pipeIdentifier = (str) => {
        return str == "═" || str == "║" 
    }
    const cornerIdentifier = (str) => {
        return str == "╗" || str == "╝" || str == "╚" || str == "╔"
    }

    let currentPipe = "═";
    let currentCorner = "╗";

    function placeTrack(){
        if(pipeIdentifier(getUndergridCell(pointer).innerText)){
            switch(currentPipe){
                case "═":
                    currentPipe = "║";
                break;
                case "║":
                    currentPipe = "═";
                break;
            }
        } else if(cornerIdentifier(getUndergridCell(pointer).innerText)){
            switch(currentCorner){
                case "╗":
                    currentCorner = "╝";
                break;
                case "╝":
                    currentCorner = "╚";
                break;
                case "╚":
                    currentCorner = "╔";
                break;
                case "╔":
                    currentCorner = "╗";
                break;
            }
        }
    }

    const directionChanges = {
        "╗": {
            directionOne: 60,
            directionTwo: -1
        },
        "╝": {
            directionOne: -60,
            directionTwo: -1
        },
        "╚": {
            directionOne: 1,
            directionTwo: -60
        },
        "╔": {
            directionOne: 1,
            directionTwo: 60
        },
        "║": {
            directionOne: 60,
            directionTwo: -60
        },
        "═": {
            directionOne: 1,
            directionTwo: -1
        }
    }

    function deleteSquares(pos){
        getGridCell(squares[pos].cellID).innerText = "";
        squares.splice(pos, 1);
        pos++
    }

    function setSquarePos(pos){
        getGridCell(squares[pos].cellID).innerText = ''
        squares[pos].cellID += squares[pos].direction;
        getGridCell(squares[pos].cellID).innerText = squares[pos].sprite
    }

    function updateSquares(){
        for(i = 0; i < squares.length; i++){
            if(squares[i].cellID < 0 || squares[i].cellID > 1799){
                deleteSquares(i);
            }
        }
    }

    document.onkeydown = function(e) {
        let key = e.key;
        // pointer movement
        if(key == "w" || key == "ArrowUp"){
            moveUp()
        } else if(key == "a" || key == "ArrowLeft"){
            moveLeft()
        } else if(key == "s" || key == "ArrowDown"){
            moveDown()
        } else if(key == "d" || key == "ArrowRight"){
            moveRight()
        } else if(key == " "){ // change edit mode
            editMode = !editMode
        }
        if(editMode){
            if(key == "Enter"){ // place square
                if(getGridCell(pointer).innerText != "■"){
                    squares.push({
                        cellID: pointer,
                        direction: 1, // 1 = right, -1 = left, -60 = up, 60 = down
                        sprite: "■"
                    })
                    getGridCell(pointer).innerText = "■"
                }
            } else if(key == "Backspace"){ // remove peice
                getUndergridCell(pointer).innerText = ""
            } else if(key == "t"){
                placeTrack()
                getUndergridCell(pointer).innerText = currentPipe
            } else if(key == "c"){
                placeTrack()
                getUndergridCell(pointer).innerText = currentCorner

            }
        }
    }

    setInterval(() => {
        updateCells()
    },10)

    setInterval(() => {
        updateSquares()
    }, 100)
    

</script>