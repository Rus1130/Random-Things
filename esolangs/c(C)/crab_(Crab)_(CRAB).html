<style>
    .io {
        width: 500px;
        height: 500px;
        resize: none;
    }
    textarea:focus {
        outline: none;
    }
    #stack {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 500px;
        height: 1240px;
    }
    #wrap {
        display: grid;
        grid-template-columns: 500px 700px;
        grid-template-rows: 500px 500px;
        row-gap: 10px;
        column-gap: 10px;
    }
    .stack-cell {
        width: 400px;
        height: 31px;
        border: 1px solid black;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: monospace;
        font-size: 20px;
    }
    #run {
        width: 500px;
        height: 50px;
        font-size: 30pt;
    }
</style>
<head>

</head>
<body>
    <div id="wrap">
        <textarea id="input" class="io" spellcheck="false" placeholder="if you want to find the docs, just add '-docs.txt' to the end of the url"></textarea>
        <div id="stack"></div>
        <textarea id="output" class="io" readonly></textarea>
    </div>
    <button id="run" onclick="run(input.value)">Run!</button>
</body>
<script>
    const stack = document.getElementById("stack");
    const input = document.getElementById("input");
    const output = document.getElementById("output");
    let outputArray = []

    async function timeout(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
    }

    function countCrab(input, keyword){
        let count = 0;
        for (j of input) {
            if (j == keyword) {
                count++;
            }
        }
        return count;
    }

    let loops = []
    let stackArray = [];

    function setCells(){
        stack.innerHTML = ''
        for(i = 0; i < 40; i++){
            let newStackCell = document.createElement('div');
            newStackCell.id = `stackCell${39 - i}`;
            newStackCell.classList.add('stack-cell');
            stack.appendChild(newStackCell);
        }
    }

    setCells()
    
    // create a function that displays the stack
    function updateStack(){
        stackArray.forEach(function(element, index){
            document.getElementById(`stackCell${index}`).innerHTML = element;
        })
    }

    async function run(instructions){
        stackArray = [];
        outputArray = [];
        loops = [];
        setCells()

        let instruction = instructions.split('\n');
        for(i = 0; i < instruction.length; i++){

            let firstKeyword = instruction[i].split(' ')[0];
            let secondKeyword = instruction[i].split(' ')[1];

            if(stackArray.length > 40){

                i = instruction.length;
                outputArray.push("Error: Stack Overflow!")

            } else if(instruction[i] == "Crab crab"){

                if(instruction[i + 1]){
                    let line = instruction[i + 1].split(' ');
                    stackArray.push(countCrab(line, 'crab') - 1);
                    i++;
                } else {
                    outputArray.push("Error: Missing Argument!")
                    i = instruction.length;
                }

            } else if(instruction[i] == 'crab Crab'){

                let lastElement = stackArray.pop();
                outputArray.push(lastElement);

            } else if(instruction[i] == 'crab crab Crab'){

                let lastElement = stackArray.pop();
                outputArray.push(lastElement);
                setCells()
                updateStack()

            } else if(instruction[i] == 'crab crab crab Crab'){

                let lastElement = stackArray.pop();
                outputArray.push(String.fromCharCode(lastElement));

            } else if(instruction[i] == 'crab crab crab crab Crab'){

                let lastElement = stackArray.pop();
                outputArray.push(String.fromCharCode(lastElement));
                setCells()
                updateStack()

            } else if(firstKeyword == 'CRAB' && secondKeyword == 'CRAB'){
                let line = instruction[i].split(' ');
                let endBlock = instruction.indexOf('CRAB CRAB Crab', i);

                let lastElement = stackArray[stackArray.length - 1];
                let crabCount = countCrab(line, 'crab') - 1;

                if(crabCount != lastElement){
                    i = endBlock;
                }
            } else if (firstKeyword == 'CRAB' && secondKeyword == 'crab'){
                let line = instruction[i].split(' ');
                let crabCount = countCrab(line, 'crab') - 2;
                let integer1 = stackArray[stackArray.length - 1];
                let integer2 = stackArray[stackArray.length - 2];
                let result;

                switch(crabCount){
                    case 0:
                        result = integer1 + integer2;
                        break;
                    case 1:
                        result = integer1 - integer2;
                        break;
                    case 2:
                        result = integer1 * integer2;
                        break;
                    case 3:
                        result = integer1 / integer2;
                        break;
                }

                stackArray.push(result);
            } else if (instruction[i] == 'crab CRAB'){
                stackArray.push(countCrab(prompt("input in crabs:").split(' '), 'crab') - 1);

            } else if (instruction[i] == 'Crab CRAB'){
                let matchingIndex = instruction.indexOf("Crab CRAB CRAB", i);
                if(matchingIndex == -1){
                    outputArray.push(`Error: Missing end of loop!`);
                    i = instruction.length;
                } else {

              }      
            } else if(instruction[i] === "Crab CRAB CRAB"){
                let matchingIndex = instruction.lastIndexOf("Crab CRAB", i);

            } else if (instruction[i] == "CRAB"){
                stackArray.pop();
                setCells()
                updateStack()
            } else if (instruction[i] == 'CRAB Crab Crab'){
                // swap the top two elements
                let temp = stackArray[stackArray.length - 1];
                stackArray[stackArray.length - 1] = stackArray[stackArray.length - 2];
                stackArray[stackArray.length - 2] = temp;


                setCells()
                updateStack()
            }
            


            output.value = outputArray.join('\n');
            updateStack()
            await timeout(100)
        }
    }


</script>