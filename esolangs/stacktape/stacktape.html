<style>
    html {
        font-family: monospace;
        user-select: none;
        font-size: 20px;
    }
    textarea {
        position: relative;
        left: -1.5px;
        top: -21px;
        height: 100px;
        width: 1039px;
        resize: none;
        font-family: monospace;
        border: 1.5px black solid;
        color: black;
        border-radius: 0%;
    }
    textarea:focus {
        border: 1.5px black solid;
        outline: none;
    }
    #macrostack {
        width: 1000px;
        height: 300px;
        display: grid;
        grid-template-columns: repeat(10, 100px);
        grid-template-rows: repeat(1, 300px);
        column-gap: 4px;
    }
    .stack {
        width: 100px;
        height: 300px;
        outline: 1.5px solid black;
        display: grid;
        grid-template-columns: repeat(1, 100px);
        grid-template-rows: repeat(10, 30px);
    }
    .microstack {
        width: 100px;
        height: 30px;
        outline: 1px solid black;
        display: flex;
        justify-content: center;
        align-items: center;

    }
    #run-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: monospace;
        border: 1.5px solid black;
        font-size: 15px;
        background-color: beige;
        width: 404px;
        height: 60px;
        font-size: 20px;
        transition: ease 0.3s;
        position: relative;
        left: 317px;
        top: -13px;
    }
    #run-btn :hover {
        background-color: #f0f0f0;
    }
</style>
<head>
</head>
<body>
    <a href="stacktape-docs.txt" download="stacktape-docs">
        <button position="absolute;">Download Stacktape Docs</button>
    </a><br><br>
    <div id="macrostack"></div><br>
    <textarea id="input" title="input"></textarea><br>
    <textarea id="output" style="position: relative; top: -17px;" title="output" readonly></textarea>
    <button title="run" id="run-btn" onclick="run(input.value)">Run!</button>
</body>
<script>
    const input = document.getElementById("input");
    const macrostack = document.getElementById("macrostack");
    const out = document.getElementById("output");

    const macrostackSize = 10
    const microstackSize = 10

    let output = []

    let metastack = []

    for (i = 0; i < 10; i++) {
        metastack.push([]);
    }

    let pointer = 0;

    function loadStacks(){
        for(i = 0; i < macrostackSize; i++){
            let stack = document.createElement("div");
            stack.classList.add("stack");
            stack.id = `s${i}`;
            macrostack.appendChild(stack);

            for(j = 0; j < microstackSize; j++){
                let microstack = document.createElement("div");
                microstack.classList.add("microstack");
                microstack.id = `s${i}m${9 - j}`
                document.getElementById(`s${i}`).appendChild(microstack);
            }
        }
        pointer = 0;
    }

    function resetStacks(){
        output = []
        metastack = []
        for (i = 0; i < 10; i++) {
            metastack.push([]);
        }
        pointer = 0;
    }

    function updateStacks(){
        for(i = 0; i < macrostackSize; i++){
            document.getElementById("s" + i).style.backgroundColor = "beige";

            if(i != pointer){
                document.getElementById("s" + i).style.backgroundColor = "white";
            }
            for(j = 0; j < microstackSize; j++){
                document.getElementById(`s${i}m${j}`).innerHTML = metastack[i][j];
                document.getElementById(`s${i}m${j}`).innerHTML = document.getElementById(`s${i}m${j}`).innerHTML.replaceAll("undefined","");
            }
        }
        out.value = output.join("").trim();
    }

    loadStacks()
    updateStacks()

    function timeout(ms) {
        return new Promise(resolve => setTimeout(resolve, ms))
    }

    function repeat(value, times){
        let result = '';
        for(let i = 0; i < times; i++){
            result += value;
        }
        return result;
    }

    async function interperet(instructions){
        for(let i = -1; i < instructions.length; i++){
            
            let prevChar = instructions[i - 1];
            let currentChar = instructions[i];
            let nextChar = instructions[i + 1];
            
            // movement =======================
            if(currentChar === ">"){
                pointer++;
                if(pointer > macrostackSize - 1){
                    pointer = 0;
                }
            }
            if(currentChar === "<"){
                pointer--;
                if(pointer < 0){
                    pointer = macrostackSize - 1;
                }
            }
            // value manipulation ==============
            if(currentChar === "@"){
                let matchingEndSpawn = instructions.indexOf("_", i);
                let value = instructions.substring(i + 1, matchingEndSpawn)
                if(matchingEndSpawn == -1){
                    output.push(`\nERROR: Matching "_" expected. (char ${i+1})`);
                    output.push(`\n${instructions}`)
                    output.push(`\n${repeat(" ", i)}^`);
                    i = instructions.length;
                } else {
                    i = matchingEndSpawn;
                    metastack[pointer].push(value);
                }
            }

            updateStacks()
            await this.timeout(100)
        }
    }


    function run(input){
        resetStacks()
        interperet(input)
        updateStacks()
    }

</script>